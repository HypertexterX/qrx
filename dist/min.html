<!DOCTYPE html><app></app><script>D=document,W=window,WL=W.location,H=history,O="os",F="files",L=localStorage,ONS="onsuccess",SI="setItem",RS="replaceState";class OS{constructor(){this.root=D.querySelector("app"),this.$={},W.addEventListener("hashchange",()=>this.R()),this.boot()}async boot(){await this.cdb(),await this.b(),await this.R()}cdb(){return new Promise((t,e)=>{let r=indexedDB.open(O,1);r.onupgradeneeded=t=>{let e=t.target.result;e.objectStoreNames.contains(F)||e.createObjectStore(F)},r[ONS]=e=>{this.db=e.target.result,t()},r.onerror=e})}tx(t="readonly"){return this.db.transaction(F,t).objectStore(F)}async write(t,e){return new Promise(r=>this.tx("readwrite").put(e,t)[ONS]=r)}async read(t){return new Promise(e=>this.tx().get(t)[ONS]=t=>e(t.target.result))}async getKeys(){return new Promise(t=>this.tx().getAllKeys()[ONS]=e=>t(e.target.result))}use(t,e){this.$[t]=e,"function"==typeof e&&e(this)}async b(){let t=(await this.getKeys()).filter(t=>t.startsWith("boot")).sort();for(let e of t){let t=await this.read(e);try{new Function(O,t)(this)}catch(t){console.error(`[Boot Error] ${e}:`,t)}}}async R(){let t=WL.hash.slice(1)||"home",[e,r]=t.split("?"),s=new URLSearchParams(r);s.has("w")&&(await this.write(e,s.get("w")),H[RS](null,"",`#${e}`));let a=["k","m","s"];for(let t of a)s.has(t)&&(L[SI](t,s.get(t)),s.delete(t),H[RS](null,"",`#${s.toString()?`${e}?${s.toString()}`:e}`));let i=L.getItem("k");if(s.has("p"))return i?void await this.g(e,L.getItem("s"),i,L.getItem("m"),WL.href):void this.r("missing api key");let o=await this.read(e);this.r(o||"")}r(t){this.root.innerHTML=t,this.RS(this.root)}RS(t){t.querySelectorAll("script").forEach(t=>{let e=D.createElement("script");Array.from(t.attributes).forEach(t=>{e.setAttribute(t.name,t.value)}),e.textContent=t.textContent,t.parentNode.replaceChild(e,t)})}async g(t,e,r,s,a){this.root.innerHTML="Thinking...";let i={contents:[{parts:[{text:`<SYSTEM>${e}</SYSTEM><CONTEXT>${await this.read(t)||""}</CONTEXT><USER_REQUEST>${a}</USER_REQUEST>`}]}]};try{let e=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${s}:streamGenerateContent?key=${r}&alt=sse`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!e.ok){let t=await e.text();throw new Error(`API Error ${e.status}: ${t}`)}let a=e.body.getReader(),o=new TextDecoder,n="",l="";for(;;){let{done:t,value:e}=await a.read();if(t)break;n+=o.decode(e,{stream:!0});let r=n.split("\n");n=r.pop();for(let t of r)if(t.startsWith("data: "))try{let e=JSON.parse(t.slice(6)),r=e.candidates?.[0]?.content?.parts?.[0]?.text;r&&(l+=r,this.root.innerHTML=l)}catch(t){}}await this.write(t,l),this.RS(this.root),H[RS](null,"",`#${t}`)}catch(t){this.root.innerHTML=`${t.message}`}}}os=new OS</script>