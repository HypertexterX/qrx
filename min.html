<!DOCTYPE html>
<app id=A></app>
<script>
D=document
W=window
L=localStorage
H=history
J=JSON
// Standard shortened DB vars
O='os';F='files';ONS='onsuccess'

class OS {
  constructor() {
    // Listen for hash changes
    W.onhashchange = () => this.R()
    this.boot()
  }

  async boot() {
    await this.db()
    // Run boot files
    let k = await this.keys(),
        b = k.filter(x => x.startsWith('boot')).sort()
    for (let f of b) {
      try {
        let s = await this.read(f)
        // Run script with 'this' as context
        (new Function(O, s))(this)
      } catch(e) { console.error(f,e) }
    }
    this.R()
  }

  // Database Connect
  db() {
    return new Promise(r => {
      let q = indexedDB.open(O)
      q.onupgradeneeded = e => e.target.result.createObjectStore(F)
      q[ONS] = e => { this.d = e.target.result; r() }
    })
  }

  // Transaction Helper
  tx(m='readonly') {
    return this.d.transaction(F, m).objectStore(F)
  }

  write(k, v) {
    return new Promise(r => this.tx('readwrite').put(v, k)[ONS] = r)
  }

  read(k) {
    return new Promise(r => this.tx().get(k)[ONS] = e => r(e.target.result))
  }

  keys() {
    return new Promise(r => this.tx().getAllKeys()[ONS] = e => r(e.target.result))
  }

  async R() {
    // URL Parsing
    let h = location.hash.slice(1) || 'home',
        [f, q] = h.split('?'),
        p = new URLSearchParams(q)

    // 1. Direct Write (?w=...)
    if (p.has('w')) {
      await this.write(f, p.get('w'))
      return H.replaceState(0,'','#'+f)
    }

    // 2. Config Setting (API Key/Model/System)
    // ?k=KEY&m=gemini-1.5-flash&s=You are a coder
    for(let k of ['k','m','s']) {
      if(p.has(k)) {
        L.setItem(k, p.get(k))
        p.delete(k)
        // Update URL cleanly
        H.replaceState(0,'','#'+(p.toString()?`${f}?${p}`:f))
      }
    }

    // 3. AI Gen (?p=...)
    if (p.has('p')) {
      return this.gen(f, p.get('p'))
    }

    // 4. Render
    let c = await this.read(f)
    this.r(c || '404')
  }

  // Render & Rehydrate Scripts
  r(h) {
    A.innerHTML = h
    A.querySelectorAll('script').forEach(o => {
      let s = D.createElement('script')
      Array.from(o.attributes).forEach(a => s.setAttribute(a.name, a.value))
      s.text = o.textContent
      o.replaceWith(s)
    })
  }

  async gen(f, prompt) {
    let k = L.getItem('k')
    if(!k) return this.r('No API Key')
    
    A.innerHTML = 'Thinking...'
    
    let c = await this.read(f),
        sys = L.getItem('s'),
        m = L.getItem('m')
    
    try {
      let req = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${m}:generateContent?key=${k}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: J.stringify({
          contents: [{
            parts: [{ text: `<SYS>${sys}</SYS><FILE>${c}</FILE><REQ>${prompt}</REQ>` }]
          }]
        })
      })
      
      let res = await req.json()
      let txt = res.candidates?.[0]?.content?.parts?.[0]?.text
      
      if(txt) {
        await this.write(f, txt)
        this.r(txt)
        H.replaceState(0,'','#'+f)
      }
    } catch(e) {
      A.innerHTML = e
    }
  }
}

os = new OS()
</script>